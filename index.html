<!DOCTYPE html>
<html>
<head>
    <title>Editor</title>
    <link rel="stylesheet" type="text/css" href="css/w2ui.min.css" />
    <link rel="stylesheet" type="text/css" href="css/style.css" />
</head>
<body>

<script src="javascript/ace-builds/src-noconflict/ace.js" type="text/javascript"></script>

<script src="javascript/File.js" type="text/javascript"></script>
<script src="javascript/Tab.js" type="text/javascript"></script>

<div id="layout"></div>

<div id="tabs"></div>
<input type="hidden" name="filename" id="filename" value="" />
<input type="text" name="cmd" value="" id="cmd" placeholder="Command"/>
<div id="editor"></div>

<script type="text/javascript">
var start = window.performance.now();

var remote = require('remote');

window.Dialog = remote.require('dialog');
window.FS = require('fs');

window.$ = window.jQuery = require(__dirname + '/javascript/jquery/jquery-2.1.4.min.js');

window.File = new File();
window.Tab = new Tab();

window.Editor = ace.edit('editor');
window.Editor.setTheme('ace/theme/chrome');
window.Editor.getSession().setMode('ace/mode/text');
window.Editor.$blockScrolling = Infinity;

window.Editor.commands.addCommand({
    name: 'save',
    bindKey: {win: 'Ctrl-S'},
    exec: function(editor) {
        window.File.Save(editor);
    }
});

window.Editor.commands.addCommand({
    name: 'cmd',
    bindKey: {win: 'Ctrl-P'},
    exec: function(editor) {
        var cmd = $('#cmd');
        cmd.show();
        cmd.focus();
    }
});
</script>

<script src="javascript/w2ui/w2ui.min.js" type="text/javascript"></script>

<script type="text/javascript">
$(function () {
    $('#tabs').w2tabs({
        name: 'tabs',
        active: 'tab1',
        tabs: [{id: 'tab1', caption: 'Untitled', closable: true}],
        onClick: function(event) {
            window.Tab.Exchange(event.object.text);
        },
        onClose: function(event) {
            window.Tab.Close(event.object.text);
        }
    });

    $('#layout').w2layout({
        name: 'layout',
        panels: [
            { type: 'left', size: 200, resizable: true, style: 'background-color: #F5F6F7;', content: 'left' },
            { type: 'main', style: 'background-color: #F5F6F7; padding: 5px;' }
        ]
    });

    $('#cmd').keypress(function(event) {
        if (event.which === 13) {
            event.preventDefault();
            alert($(this).val());
            $(this).hide();
        }
    });

    var sidebarNr = 0;
    function readDirectory(folder) {
        var entries = window.FS.readdirSync(folder);
        var len = entries.length;

        var nodes = new Array(len);

        for (var i = 0; i < len; i++) {
            var file = entries[i];
            var obj = {text: file, img: 'icon-page'};

            var path = folder + '/' + file;
            var stat = window.FS.statSync(path);

            if (stat && stat.isDirectory()) {
                if (file.split('/').pop()[0] === '.') {
                    continue;
                }

                obj.id = 'Folder-' + sidebarNr;
                obj.img = 'icon-folder';

                sidebarNr += 1;

                obj.nodes = readDirectory(path);
            } else {
                obj.id = 'File-' + sidebarNr;
                obj.img = 'icon-page';
            }

            sidebarNr += 1;

            nodes[i] = obj;
        }

        return nodes;
    }

    w2ui['layout'].content('left', $().w2sidebar({
        name: 'sidebar',
        img: null,
        nodes: readDirectory(__dirname),
        onClick: function(event) {
            window.File.Open(event.node.text);
        }
    }));
});

var end = window.performance.now();

console.log(start + ' to ' + end + ' = ' + (end - start) + 'ms');
</script>
</body>
</html>
